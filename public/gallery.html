<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>Gallery</title>
  <link rel="stylesheet" href="css/gallery.css">
</head>

<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <span class="brand">CareEmotion</span>
    </div>
  </header>

  <h1>Image Upload</h1>

  <a href="home.html" class="back-btn">
    <img src="/assets/backarrow.png" alt="Back">
  </a>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏π‡∏õ -->
  <div class="upload-wrapper">
    <label for="imageInput" class="upload-label">
      <img src="/assets/uploadicon.png" alt="Upload">
      <span>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
    </label>
    <input type="file" id="imageInput" accept="image/*">
  </div>

  <!-- ‡πÅ‡∏™‡∏î‡∏á gallery -->
  <div class="gallery-wrapper" id="gallery"></div>

  <div id="loading" class="loading" style="display:none;">
    <div class="loader"></div>
    <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå...</span>
  </div>

  <!-- Wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏•‡∏∞ heatmap -->
  <div class="result-heatmap-wrapper" style="display:none;" id="resultWrapper">
    <div id="result" class="result-box"></div>
    <div id="heatmapBox" class="heatmap-box"></div>
  </div>

  <!-- Info-card -->
  <div class="info-card">
    <div class="info-section">
      <h3>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image Upload)</h3>
      <ol>
        <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå </li>
        <li>‡∏£‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</li>
      </ol>
      <p>üìä <strong>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</strong> ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô</p>
    </div>
  </div>

  <!-- Footer -->
  <div class="bottom-footer">
    by ‡∏à‡∏±‡πà‡∏á‡∏ã‡∏µ‡πâ‡∏°‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≠‡∏ô
  </div>

  <script>
    const imageInput = document.getElementById('imageInput');
    const gallery = document.getElementById('gallery');
    const loading = document.getElementById('loading');
    const resultBox = document.getElementById('result');
    const heatmapBox = document.getElementById('heatmapBox');
    const resultWrapper = document.getElementById('resultWrapper');
    const infoCard = document.querySelector('.info-card');

    function showLoader() {
      loading.style.display = 'flex';
    }

    function hideLoader() {
      loading.style.display = 'none';
    }

    imageInput.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      // ‡∏¢‡πà‡∏≠‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏á
      document.querySelector('.upload-wrapper').classList.add('shrink');

      // ‡πÅ‡∏™‡∏î‡∏á preview
      const reader = new FileReader();
      reader.onload = function (e) {
        gallery.innerHTML = '';
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'gallery-item';
        gallery.appendChild(img);
      }
      reader.readAsDataURL(file);

      infoCard.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á backend
      const formData = new FormData();
      formData.append('image', file);

      // Show loader
      showLoader();
      resultWrapper.style.display = 'none';
      resultBox.innerHTML = '';
      heatmapBox.innerHTML = '';

      try {
        const response = await fetch('http://localhost:3000/predict', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        hideLoader();

        if (data.error) {
          resultBox.innerHTML = `<p style="color:red;">‚ùå ${data.error}</p>`;
          resultWrapper.style.display = 'block';
          return;
        }

        const { emotion, confidence, all, heatmap_path } = data.prediction || data;

        // ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        let resultHtml = `<h3>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏Å: ${emotion} (${(confidence * 100).toFixed(1)}%)</h3>`;
        resultHtml += `<div><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong></div>`;
        all.forEach(item => {
          const percent = (item.score * 100).toFixed(1);
          resultHtml += `
            <div class="result-item">
              <div class="result-label">${item.label} ‚Äî ${percent}%</div>
              <div class="bar"><div class="bar-fill" style="width:${percent}%;"></div></div>
            </div>
          `;
        });
        resultBox.innerHTML = resultHtml;

        // Heatmap
        if (heatmap_path) {
          const heatmapUrl = `http://localhost:3000/static/${heatmap_path}`;
          heatmapBox.innerHTML = `
            <h4>üîç ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï:</h4>
            <img src="${heatmapUrl}" class="heatmap-image" alt="Heatmap Result">
          `;
        }

        // ‡πÅ‡∏™‡∏î‡∏á wrapper ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        resultWrapper.style.display = 'flex';
      } catch (err) {
        hideLoader();
        resultBox.innerHTML = `<p style="color:red;">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</p>`;
        resultWrapper.style.display = 'flex';
      }
    });
  </script>

</body>

</html>